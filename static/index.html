<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Agent AI - Tạo Form Tự Động</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .form-generator {
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f7fafc;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .generated-form {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8fafc;
            border-radius: 16px;
            border-left: 5px solid #667eea;
        }
        
        .generated-form.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-info {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-info h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-preview {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-field {
            margin-bottom: 20px;
        }
        
        .field-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .required {
            color: #e53e3e;
        }
        
        .field-description {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .checkbox-group, .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input, .radio-item input {
            width: auto;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #718096;
        }
        
        .form-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .error-message {
            color: #e53e3e;
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 8px 12px;
            background: #fed7d7;
            border-radius: 6px;
            display: none;
        }
        
        .success-message {
            color: #38a169;
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 8px 12px;
            background: #c6f6d5;
            border-radius: 6px;
            display: none;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .complexity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .complexity-simple {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .complexity-moderate {
            background: #feebc8;
            color: #744210;
        }
        
        .complexity-complex {
            background: #fed7d7;
            color: #742a2a;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-card {
                padding: 25px 20px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Form Agent AI</h1>
            <p>Tạo form chuyên nghiệp tự động từ từ khóa</p>
        </div>
        
        <div class="main-card">
            <div class="form-generator">
                <h2 style="margin-bottom: 25px; color: #2d3748;">Tạo Form Mới</h2>
                
                <form id="generatorForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="keyword">Từ khóa *</label>
                                <input type="text" id="keyword" class="form-control" 
                                       placeholder="VD: đánh giá bảo mật cloud, phân tích đầu tư, chiến dịch marketing" 
                                       required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="category">Lĩnh vực</label>
                                <select id="category" class="form-control">
                                    <option value="">Tự động phát hiện</option>
                                    <option value="it">Công nghệ thông tin</option>
                                    <option value="economics">Kinh tế - Tài chính</option>
                                    <option value="marketing">Marketing</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="complexity">Độ phức tạp</label>
                                <select id="complexity" class="form-control">
                                    <option value="">Tự động xác định</option>
                                    <option value="Simple">Đơn giản</option>
                                    <option value="Moderate">Trung bình</option>
                                    <option value="Complex">Phức tạp</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="formType">Loại form</label>
                                <select id="formType" class="form-control">
                                    <option value="">Tự động chọn</option>
                                    <option value="registration">Đăng ký</option>
                                    <option value="survey">Khảo sát</option>
                                    <option value="application">Đơn ứng tuyển</option>
                                    <option value="consultation">Tư vấn</option>
                                    <option value="assessment">Đánh giá</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalRequirements">Yêu cầu bổ sung (tùy chọn)</label>
                        <textarea id="additionalRequirements" class="form-control" rows="3" 
                                  placeholder="Mô tả thêm các yêu cầu đặc biệt cho form..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" id="generateBtn">
                        Tạo Form
                    </button>
                </form>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    Đang tạo form với AI...
                </div>
            </div>
            
            <div class="generated-form" id="generatedForm">
                <div class="form-info" id="formInfo">
                    <!-- Form info will be populated here -->
                </div>
                
                <div class="form-preview" id="formPreview">
                    <!-- Form preview will be populated here -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="editForm()">
                        Chỉnh sửa
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveForm()">
                        Lưu Form
                    </button>
                    <button type="button" class="btn" onclick="downloadForm()">
                        Tải xuống
                    </button>
                    <button type="button" class="btn" onclick="shareForm()">
                        Chia sẻ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000/api';
        
        // Global variables
        let currentForm = null;
        
        // DOM elements
        const generatorForm = document.getElementById('generatorForm');
        const loading = document.getElementById('loading');
        const generatedForm = document.getElementById('generatedForm');
        const generateBtn = document.getElementById('generateBtn');
        
        // Event listeners
        generatorForm.addEventListener('submit', handleFormGeneration);
        
        // Main form generation handler
        async function handleFormGeneration(e) {
            e.preventDefault();
            
            const formData = {
                keyword: document.getElementById('keyword').value.trim(),
                category: document.getElementById('category').value || null,
                complexity: document.getElementById('complexity').value || null,
                form_type: document.getElementById('formType').value || null,
                additional_requirements: document.getElementById('additionalRequirements').value.trim() || null
            };
            
            if (!formData.keyword) {
                showError('Vui lòng nhập từ khóa');
                return;
            }
            
            try {
                showLoading(true);
                hideGeneratedForm();
                
                const response = await fetch(`${API_BASE}/generate-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Lỗi tạo form');
                }
                
                const result = await response.json();
                currentForm = result;
                
                displayGeneratedForm(result);
                
            } catch (error) {
                console.error('Form generation error:', error);
                showError(error.message || 'Có lỗi xảy ra khi tạo form');
            } finally {
                showLoading(false);
            }
        }
        
        // Display generated form
        function displayGeneratedForm(formData) {
            displayFormInfo(formData);
            displayFormPreview(formData);
            showGeneratedForm();
        }
        
        // Display form information
        function displayFormInfo(formData) {
            const formInfo = document.getElementById('formInfo');
            
            const categoryBadge = `<span class="category-badge">${getCategoryName(formData.category)}</span>`;
            const complexityBadge = `<span class="complexity-badge complexity-${formData.complexity.toLowerCase()}">${formData.complexity}</span>`;
            
            formInfo.innerHTML = `
                <h3>${formData.title}</h3>
                <p style="margin-bottom: 20px; color: #718096;">${formData.description}</p>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Lĩnh vực</div>
                        <div class="info-value">${categoryBadge}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Loại form</div>
                        <div class="info-value">${getFormTypeName(formData.form_type)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Độ phức tạp</div>
                        <div class="info-value">${complexityBadge}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Số trường</div>
                        <div class="info-value">${formData.fields.length} trường</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Thời gian ước tính</div>
                        <div class="info-value">${formData.metadata.estimated_completion_time} phút</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ID Form</div>
                        <div class="info-value">${formData.form_id}</div>
                    </div>
                </div>
            `;
        }
        
        // Display form preview
        function displayFormPreview(formData) {
            const formPreview = document.getElementById('formPreview');
            
            let fieldsHtml = '';
            
            formData.fields.forEach(field => {
                fieldsHtml += generateFieldHtml(field);
            });
            
            formPreview.innerHTML = `
                <form id="previewForm" onsubmit="handleFormSubmission(event)">
                    <h3 style="margin-bottom: 25px; color: #2d3748;">${formData.title}</h3>
                    ${fieldsHtml}
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button type="submit" class="btn">
                            Gửi Form (Demo)
                        </button>
                    </div>
                </form>
            `;
        }
        
        // Generate HTML for individual field
        function generateFieldHtml(field) {
            const requiredMark = field.required ? '<span class="required">*</span>' : '';
            const description = field.description ? `<div class="field-description">${field.description}</div>` : '';
            
            let inputHtml = '';
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'tel':
                case 'url':
                case 'password':
                case 'number':
                case 'date':
                case 'time':
                    inputHtml = `
                        <input type="${field.type}" 
                               name="${field.name}" 
                               class="form-control"
                               placeholder="${field.placeholder || ''}"
                               ${field.required ? 'required' : ''}
                               ${field.validation ? getValidationAttributes(field.validation) : ''}>
                    `;
                    break;
                    
                case 'textarea':
                    inputHtml = `
                        <textarea name="${field.name}" 
                                  class="form-control"
                                  placeholder="${field.placeholder || ''}"
                                  ${field.required ? 'required' : ''}
                                  ${field.validation ? getValidationAttributes(field.validation) : ''}></textarea>
                    `;
                    break;
                    
                case 'select':
                    const options = field.options || [];
                    const optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    inputHtml = `
                        <select name="${field.name}" class="form-control" ${field.required ? 'required' : ''}>
                            <option value="">-- Chọn --</option>
                            ${optionsHtml}
                        </select>
                    `;
                    break;
                    
                case 'radio':
                    const radioOptions = field.options || [];
                    const radioHtml = radioOptions.map(opt => `
                        <div class="radio-item">
                            <input type="radio" name="${field.name}" value="${opt}" id="${field.name}_${opt.replace(/\s+/g, '_')}" ${field.required ? 'required' : ''}>
                            <label for="${field.name}_${opt.replace(/\s+/g, '_')}">${opt}</label>
                        </div>
                    `).join('');
                    inputHtml = `<div class="radio-group">${radioHtml}</div>`;
                    break;
                    
                case 'checkbox':
                    const checkboxOptions = field.options || [];
                    const checkboxHtml = checkboxOptions.map(opt => `
                        <div class="checkbox-item">
                            <input type="checkbox" name="${field.name}[]" value="${opt}" id="${field.name}_${opt.replace(/\s+/g, '_')}">
                            <label for="${field.name}_${opt.replace(/\s+/g, '_')}">${opt}</label>
                        </div>
                    `).join('');
                    inputHtml = `<div class="checkbox-group">${checkboxHtml}</div>`;
                    break;
                    
                case 'range':
                    const min = field.validation?.min_value || 0;
                    const max = field.validation?.max_value || 10;
                    inputHtml = `
                        <input type="range" 
                               name="${field.name}" 
                               min="${min}" 
                               max="${max}"
                               value="${(min + max) / 2}"
                               class="form-control"
                               oninput="updateRangeValue(this)"
                               ${field.required ? 'required' : ''}>
                        <div class="range-labels">
                            <span>${min}</span>
                            <span id="${field.name}_value">${(min + max) / 2}</span>
                            <span>${max}</span>
                        </div>
                    `;
                    break;
                    
                case 'file':
                    inputHtml = `
                        <input type="file" 
                               name="${field.name}" 
                               class="form-control"
                               ${field.required ? 'required' : ''}>
                    `;
                    break;
                    
                default:
                    inputHtml = `
                        <input type="text" 
                               name="${field.name}" 
                               class="form-control"
                               placeholder="${field.placeholder || ''}"
                               ${field.required ? 'required' : ''}>
                    `;
            }
            
            return `
                <div class="form-field">
                    <label class="field-label">${field.label}${requiredMark}</label>
                    ${description}
                    ${inputHtml}
                </div>
            `;
        }
        
        // Get validation attributes for HTML
        function getValidationAttributes(validation) {
            let attrs = [];
            
            if (validation.min_length) attrs.push(`minlength="${validation.min_length}"`);
            if (validation.max_length) attrs.push(`maxlength="${validation.max_length}"`);
            if (validation.min_value !== undefined) attrs.push(`min="${validation.min_value}"`);
            if (validation.max_value !== undefined) attrs.push(`max="${validation.max_value}"`);
            if (validation.pattern) attrs.push(`pattern="${validation.pattern}"`);
            
            return attrs.join(' ');
        }
        
        // Handle form submission (demo)
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            if (!currentForm) return;
            
            const formData = new FormData(e.target);
            const data = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const cleanKey = key.slice(0, -2);
                    if (!data[cleanKey]) data[cleanKey] = [];
                    data[cleanKey].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/submit-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        form_id: currentForm.form_id,
                        form_data: data
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('Form đã được gửi thành công!');
                } else {
                    showError(result.detail || 'Có lỗi xảy ra khi gửi form');
                }
                
            } catch (error) {
                console.error('Form submission error:', error);
                showError('Có lỗi xảy ra khi gửi form');
            }
        }
        
        // Utility functions
        function showLoading(show) {
            loading.classList.toggle('show', show);
            generateBtn.disabled = show;
        }
        
        function showGeneratedForm() {
            generatedForm.classList.add('show');
        }
        
        function hideGeneratedForm() {
            generatedForm.classList.remove('show');
        }
        
        function showError(message) {
            alert('Lỗi: ' + message); // In production, use better error display
        }
        
        function showSuccess(message) {
            alert(message); // In production, use better success display
        }
        
        function getCategoryName(category) {
            const names = {
                'it': 'Công nghệ thông tin',
                'economics': 'Kinh tế - Tài chính',
                'marketing': 'Marketing'
            };
            return names[category] || category;
        }
        
        function getFormTypeName(formType) {
            const names = {
                'registration': 'Đăng ký',
                'survey': 'Khảo sát',
                'application': 'Đơn ứng tuyển',
                'consultation': 'Tư vấn',
                'assessment': 'Đánh giá'
            };
            return names[formType] || formType;
        }
        
        function updateRangeValue(input) {
            const valueDisplay = document.getElementById(input.name + '_value');
            if (valueDisplay) {
                valueDisplay.textContent = input.value;
            }
        }
        
        // Form actions
        function editForm() {
            if (!currentForm) return;
            
            // Populate the generator form with current values
            document.getElementById('keyword').value = currentForm.keyword;
            document.getElementById('category').value = currentForm.category;
            document.getElementById('complexity').value = currentForm.complexity;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function saveForm() {
            if (!currentForm) return;
            
            // In a real app, this would save to backend
            const formJson = JSON.stringify(currentForm, null, 2);
            const blob = new Blob([formJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `form_${currentForm.form_id}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Form đã được lưu!');
        }
        
        function downloadForm() {
            if (!currentForm) return;
            
            // Generate HTML for the form
            let html = generateStandaloneFormHtml(currentForm);
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `form_${currentForm.form_id}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('File HTML đã được tải xuống!');
        }
        
        function shareForm() {
            if (!currentForm) return;
            
            const shareUrl = `${window.location.origin}/forms/${currentForm.form_id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentForm.title,
                    text: currentForm.description,
                    url: shareUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSuccess('Link form đã được sao chép vào clipboard!');
                });
            }
        }
        
        function generateStandaloneFormHtml(formData) {
            let fieldsHtml = '';
            formData.fields.forEach(field => {
                fieldsHtml += generateFieldHtml(field);
            });
            
            return `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${formData.title}</title>
    <style>
        /* Add your CSS styles here */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-control { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .form-field { margin-bottom: 20px; }
        .field-label { display: block; font-weight: bold; margin-bottom: 5px; }
        .required { color: red; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>${formData.title}</h1>
    <p>${formData.description}</p>
    <form>
        ${fieldsHtml}
        <button type="submit" class="btn">Gửi</button>
    </form>
</body>
</html>
            `;
        }
    </script>
</body>
</html>
